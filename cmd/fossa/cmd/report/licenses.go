package report

import (
	"encoding/json"
	"fmt"
	"text/template"

	"github.com/apex/log"
	"github.com/urfave/cli"

	"github.com/fossas/fossa-cli/api/fossa"
	"github.com/fossas/fossa-cli/cmd/fossa/display"
	"github.com/fossas/fossa-cli/cmd/fossa/flags"
	"github.com/fossas/fossa-cli/cmd/fossa/setup"
	"github.com/fossas/fossa-cli/config"
	"github.com/fossas/fossa-cli/errors"
)

const defaultLicenseReportTemplate = `# 3rd-Party Software License Notice
Generated by fossa-cli (https://github.com/fossas/fossa-cli).
This software includes the following software and licenses:
{{range $license, $deps := .}}
========================================================================
{{$license}}
========================================================================
The following software have components provided under the terms of this license:
{{range $i, $dep := $deps}}
- {{$dep.Project.Title}} (from {{$dep.Project.URL}})
{{- end}}
{{end}}
`

const JSON = "json"

var licensesCmd = cli.Command{
	Name:  "licenses",
	Usage: "Generate licenses report",
	Flags: flags.WithGlobalFlags(flags.WithAPIFlags(flags.WithOptions(flags.WithReportTemplateFlags([]cli.Flag{
		cli.BoolFlag{Name: JSON, Usage: "format output as JSON"},
	})))),
	Action: licensesRun,
}

func licensesRun(ctx *cli.Context) (err error) {
	err = setup.SetContext(ctx)
	if err != nil {
		log.Fatalf("Could not initialize: %s", err.Error())
	}

	defer display.ClearProgress()
	display.InProgress(fmt.Sprint("Fetching License Information"))

	revs := make([]fossa.Revision, 0)
	locator := fossa.Locator{
		Fetcher:  config.Fetcher(),
		Project:  config.Project(),
		Revision: config.Revision(),
	}
	revs, err = fossa.GetRevisionDependencies(locator)
	if err != nil {
		return errors.Wrapf(err, "Unable to find licenses for project %s:", locator)
	}

	if ctx.Bool(JSON) {
		output, err := json.Marshal(revs)
		if err != nil {
			return err
		}
		fmt.Println(string(output))
		return nil
	}

	depsByLicense := make(map[string]map[string]fossa.Revision)
	for _, rev := range revs {
		for _, license := range rev.Licenses {
			if _, ok := depsByLicense[license.LicenseID]; !ok {
				depsByLicense[license.LicenseID] = make(map[string]fossa.Revision)
			}
			depsByLicense[license.LicenseID][rev.Locator.String()] = rev
		}
	}

	if tmplFile := ctx.String(flags.Template); tmplFile != "" {
		output, err := display.TemplateFile(tmplFile, depsByLicense)
		fmt.Println(output)
		if err != nil {
			log.Fatalf("Could not parse template data: %s", err.Error())
		}
		return nil
	}

	tmpl, err := template.New("base").Parse(defaultLicenseReportTemplate)
	if err != nil {
		log.Fatalf("Could not parse template data: %s", err.Error())
	}

	output, err := display.Template(tmpl, depsByLicense)
	fmt.Println(output)
	return nil
}
